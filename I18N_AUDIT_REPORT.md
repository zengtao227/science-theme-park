# I18N and LaTeX Formatting Audit Report

**Date**: 2026-02-18  
**Scope**: All 78 chamber modules  
**Issues Found**: 22 modules with i18n/formatting problems

---

## 问题总结

在审查 SM1.01 模块时，用户发现了三个关键问题：

### 1. 任务目标文本没有国际化 (i18n)
**问题**: 不管切换什么语言（EN/CN/DE），某些文本始终显示英文。

**示例**:
```typescript
// ❌ 错误 - 硬编码英文
promptLatex: `\\text{Basel park rectangular garden}`

// ✅ 正确 - 使用 i18n
promptLatex: `\\text{${t.quests.basel_park}}`
```

### 2. 数学符号格式错误
**问题**: 单位使用了错误的 LaTeX 格式，学生看到的不是标准数学符号。

**示例**:
```typescript
// ❌ 错误 - 显示为 "A=180m^2" (上标不正确)
unit: "m^2"

// ✅ 正确 - 显示为 "A=180 m²" (正确的数学格式)
unit: "\\text{m}^2"
```

### 3. 可视化组件文本没有国际化
**问题**: 右侧监控面板的标签（如 "REAL-TIME GEOMETRY"）只有英文。

**示例**:
```typescript
// ❌ 错误 - 硬编码英文
<div>REAL-TIME GEOMETRY</div>

// ✅ 正确 - 使用 i18n
<div>{sm1_01_t.quests.realtime_geo}</div>
```

---

## 扫描结果

扫描了所有 78 个 chamber 模块，发现 **22 个模块** 存在类似问题：

### 高优先级（需要立即修复）

| 模块 | 问题数量 | 主要问题类型 |
|------|---------|------------|
| **SP3-04** | 50 | 大量硬编码英文文本 + 单位格式错误 |
| **SM1-03** | 45 | 所有提示文本都是硬编码英文 |
| **SC3-01** | 19 | 有机化学公式描述硬编码 |
| **GP2-02** | 19 | 热力学过程描述硬编码 |
| **SM1-04** | 19 | 代数场景硬编码 |
| **SM2-08** | 15 | 几何计算提示硬编码 |

### 中优先级

| 模块 | 问题数量 | 主要问题类型 |
|------|---------|------------|
| **SP3-01** | 12 | 单位转换文本硬编码 |
| **SP3-05** | 12 | 杠杆问题描述硬编码 |
| **EM1-01** | 10 | 泰勒斯定理场景硬编码 |
| **GP2-01** | 10 | 理想气体定律描述硬编码 |
| **SC2-05** | 8 | 酸碱化学术语硬编码 |

### 低优先级

| 模块 | 问题数量 | 主要问题类型 |
|------|---------|------------|
| **SM1-01** | 5 | ✅ 已修复 |
| **GB1-01** | 4 | 进化论术语硬编码 |
| **SC3-05** | 3 | 分子几何术语硬编码 |
| **SP3-08** | 3 | 光学定律描述硬编码 |
| **SM1-02** | 2 | 代数表达式提示硬编码 |
| **SM1-05** | 2 | 比例问题硬编码 |
| **SM3-05** | 2 | 罗氏大厦场景硬编码 |
| **GB2-01** | 1 | 神经生物学术语硬编码 |
| **SC1-01** | 1 | 化学实验提示硬编码 |
| **SC2-01** | 1 | 反应速率描述硬编码 |
| **SP3-06** | 1 | 声学强度描述硬编码 |

---

## 修复策略

### 第一步：更新 i18n 翻译文件

为每个模块在 `src/lib/i18n/{en,cn,de}/{subject}.ts` 中添加缺失的翻译键。

**示例** (SM1.01 已完成):
```typescript
// src/lib/i18n/en/math.ts
sm1_01: {
    quests: {
        basel_park: "Basel park rectangular garden",
        basel_cathedral_tri: "Basel Cathedral roof triangle",
        // ... 更多场景
        realtime_geo: "REAL-TIME GEOMETRY",
    }
}

// src/lib/i18n/cn/math.ts
sm1_01: {
    quests: {
        basel_park: "巴塞尔公园长方形花园",
        basel_cathedral_tri: "巴塞尔大教堂屋顶三角形",
        // ... 更多场景
        realtime_geo: "实时几何",
    }
}

// src/lib/i18n/de/math.ts
sm1_01: {
    quests: {
        basel_park: "Basel Park rechteckiger Garten",
        basel_cathedral_tri: "Basler Münster Dachdreieck",
        // ... 更多场景
        realtime_geo: "ECHTZEIT-GEOMETRIE",
    }
}
```

### 第二步：修复模块代码

1. **替换硬编码文本为 i18n 键**:
```typescript
// 在组件顶部创建翻译对象
const module_t = {
    // ... 其他翻译
    quests: {
        basel_park: t("module_name.quests.basel_park"),
        // ... 更多键
    }
};

// 在 buildStagePool 函数中使用
promptLatex: `\\text{${t.quests.basel_park}}`
```

2. **修复单位格式**:
```typescript
// 查找并替换所有单位
unit: "m^2"  → unit: "\\text{m}^2"
unit: "m^3"  → unit: "\\text{m}^3"
unit: "cm^2" → unit: "\\text{cm}^2"
unit: "cm^3" → unit: "\\text{cm}^3"
```

3. **修复监控标签**:
```typescript
// 将硬编码标签替换为翻译
<div>REAL-TIME GEOMETRY</div>
→
<div>{module_t.labels.realtime_geo}</div>
```

### 第三步：验证

1. 运行构建: `npm run build`
2. 在浏览器中测试每个难度级别
3. 切换语言 (EN/CN/DE) 验证所有文本都正确翻译
4. 检查数学符号显示是否正确

---

## 自动化修复脚本

已创建两个 Python 脚本辅助修复：

### 1. `scan_all_modules_i18n.py`
扫描所有模块，识别 i18n 和格式问题。

**使用方法**:
```bash
python3 scan_all_modules_i18n.py
```

### 2. `fix_sm1_01_i18n.py`
SM1.01 的修复脚本示例，可作为其他模块的模板。

**使用方法**:
```bash
python3 fix_sm1_01_i18n.py
```

---

## 修复进度

- [x] **SM1.01** - ✅ 已完成并验证
- [ ] **SP3-04** - 50 个问题（高优先级）
- [ ] **SM1-03** - 45 个问题（高优先级）
- [ ] **SC3-01** - 19 个问题（高优先级）
- [ ] **GP2-02** - 19 个问题（高优先级）
- [ ] **SM1-04** - 19 个问题（高优先级）
- [ ] **SM2-08** - 15 个问题（中优先级）
- [ ] **SP3-01** - 12 个问题（中优先级）
- [ ] **SP3-05** - 12 个问题（中优先级）
- [ ] **EM1-01** - 10 个问题（中优先级）
- [ ] **GP2-01** - 10 个问题（中优先级）
- [ ] **SC2-05** - 8 个问题（中优先级）
- [ ] **GB1-01** - 4 个问题（低优先级）
- [ ] **SC3-05** - 3 个问题（低优先级）
- [ ] **SP3-08** - 3 个问题（低优先级）
- [ ] **SM1-02** - 2 个问题（低优先级）
- [ ] **SM1-05** - 2 个问题（低优先级）
- [ ] **SM3-05** - 2 个问题（低优先级）
- [ ] **GB2-01** - 1 个问题（低优先级）
- [ ] **SC1-01** - 1 个问题（低优先级）
- [ ] **SC2-01** - 1 个问题（低优先级）
- [ ] **SP3-06** - 1 个问题（低优先级）

---

## 预计工作量

- **高优先级模块** (6个): 每个约 2-3 小时 = 12-18 小时
- **中优先级模块** (6个): 每个约 1-2 小时 = 6-12 小时
- **低优先级模块** (10个): 每个约 0.5-1 小时 = 5-10 小时

**总计**: 约 23-40 小时工作量

---

## 建议

1. **优先修复高优先级模块** - 这些模块问题最多，影响用户体验最大
2. **创建模板脚本** - 基于 SM1.01 的修复经验，为其他模块创建类似的自动化脚本
3. **批量处理** - 按学科分组修复（数学、物理、化学、生物）
4. **持续验证** - 每修复一个模块就进行构建和浏览器测试

---

## 经验总结

从 SM1.01 的修复中学到的关键点：

1. **i18n 键命名规范**: 使用描述性名称，如 `basel_park` 而不是 `scenario_1`
2. **LaTeX 格式**: 单位必须使用 `\\text{}` 包裹，确保正确渲染
3. **翻译对象结构**: 在组件中创建 `module_t` 对象，集中管理所有翻译
4. **监控标签**: 不要忘记可视化组件中的文本也需要国际化
5. **构建验证**: 每次修改后都要运行 `npm run build` 确保没有 TypeScript 错误

---

## 下一步行动

1. ✅ 修复 SM1.01（已完成）
2. 📝 创建此审计报告（已完成）
3. 🔄 开始修复高优先级模块（SP3-04, SM1-03, SC3-01, GP2-02, SM1-04, SM2-08）
4. 🔄 继续修复中优先级模块
5. 🔄 最后修复低优先级模块
6. ✅ 全面测试所有模块的三语支持

