# 语言切换 Bug 诊断报告

**报告时间**: 2026-02-18  
**最后更新**: 2026-02-18  
**问题严重性**: 🚨 严重 - 影响用户体验

---

## 📋 执行摘要

### 问题描述
用户切换语言时，模块内的问题描述（context）和场景（scenario）不会更新，只有标题和按钮等 UI 元素会切换语言。

### 根本原因
使用了 `useCallback` 且依赖数组为空 `[]`，导致内部的 `t()` 函数调用被"冻结"在首次渲染时的语言。

### 影响范围
- **总模块数**: 78 个
- **受影响模块**: 12 个 (15.4%)
- **正常模块**: 66 个 (84.6%)

---

## 🔍 诊断结果

### 严重问题模块（12 个）

| 模块 | 主题 | 状态 | 优先级 |
|------|------|------|--------|
| **SM1-03** | 数学-整数 | ✅ 已修复 | 🔴 高（已完成 i18n） |
| **SM1-04** | 数学-代数 | ✅ 已修复 | 🔴 高（已完成 i18n） |
| **SM2-08** | 数学-几何 | ✅ 已修复 | 🔴 高（已完成 i18n） |
| **GC1-02** | 生物 | ⏳ 待修复 | 🟡 中 |
| **SB2-01-TISSUES** | 生物-组织 | ⏳ 待修复 | 🟡 中 |
| **SB2-02-BODY-SYSTEMS** | 生物-系统 | ⏳ 待修复 | 🟡 中 |
| **SC2-01** | 化学 | ⏳ 待修复 | 🟡 中 |
| **SM1-05** | 数学 | ⏳ 待修复 | 🟡 中 |
| **SM2-10** | 数学 | ⏳ 待修复 | 🟡 中 |
| **SM3-05** | 数学 | ⏳ 待修复 | 🟡 中 |
| **SP3-05** | 物理 | ⏳ 待修复 | 🟡 中 |
| **SP3-06** | 物理 | ⏳ 待修复 | 🟡 中 |

---

## 🛠️ 修复进度

### Phase 1: 高优先级模块（3 个）
- [x] SM1-03 - 数学整数（60 个翻译）✅ 已完成
- [x] SM1-04 - 数学代数（80 个翻译）✅ 已完成
- [x] SM2-08 - 数学几何（107 个翻译）✅ 已完成

### Phase 2: 其他模块（9 个）
- [x] SC2-01 ✅ 已完成
- [x] GC1-02 ✅ 不需要修复
- [x] SB2-01-TISSUES ✅ 不需要修复
- [x] SB2-02-BODY-SYSTEMS ✅ 不需要修复
- [x] SM1-05 ✅ 不需要修复
- [x] SM2-10 ✅ 不需要修复
- [x] SM3-05 ✅ 不需要修复
- [x] SP3-05 ✅ 不需要修复
- [x] SP3-06 ✅ 不需要修复

**总进度**: 12/12 (100%) ✅ 全部完成！

**实际需要修复**: 4/12 (33.3%)  
**不需要修复**: 8/12 (66.7%)

---

## ✅ 已完成修复

### 需要修复的模块（4个）
1. **SM1-03** - 数学整数 ✅ 已修复
2. **SM1-04** - 数学代数 ✅ 已修复
3. **SM2-08** - 数学几何 ✅ 已修复
4. **SC2-01** - 化学动力学 ✅ 已修复

### 不需要修复的模块（8个）
这些模块没有在 buildStagePool 内部使用 `t()` 调用，因此不受语言切换 Bug 影响：
- GC1-02
- SM1-05
- SM2-10
- SM3-05
- SP3-05
- SP3-06
- SB2-01-TISSUES
- SB2-02-BODY-SYSTEMS

**总进度**: 12/12 (100%) ✅ 全部完成！

---

## 🔧 修复方法

### 正确模式（已在 SM1-03 中实现）

```typescript
// 1. 预提取所有翻译
const sm1_03_t = {
  scenarios: {
    number_line: t("sm1_03.scenarios.number_line"),
    // ...
  },
  problems: {
    nl_identify_neg3: t("sm1_03.problems.nl_identify_neg3"),
    // ...
  }
};

// 2. buildStagePool 接受翻译对象
const buildStagePool = useCallback(
  (tObj: typeof sm1_03_t, difficulty: Difficulty, stage: Stage) => {
    return [{
      scenario: tObj.scenarios.number_line,  // ✅ 使用翻译对象
      context: tObj.problems.nl_identify_neg3,
    }];
  },
  []
);

// 3. buildPool 依赖翻译对象
const buildPool = useCallback(
  (difficulty: Difficulty, stage: Stage) => 
    buildStagePool(sm1_03_t, difficulty, stage),
  [sm1_03_t]  // ✅ 依赖翻译对象
);
```

---

## 📝 下一步

1. 完成 SM1-04 和 SM2-08 的修复
2. 验证所有高优先级模块的语言切换功能
3. 继续修复其他 9 个模块
4. 运行完整的构建和测试
5. 更新 I18N_BATCH_FIX_TASKS.md

---

**最后更新**: 2026-02-18  
**状态**: ✅ 已完成 (12/12 = 100%)
